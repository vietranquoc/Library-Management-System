<div class="admin-wrapper">
  <header class="admin-header">
    <div class="logo">üìö Library Management - Admin</div>
    <div class="header-right">
      <a routerLink="/admin/dashboard" class="back-link">‚Üê V·ªÅ Dashboard</a>
    </div>
  </header>

  <div class="admin-container">
    <app-admin-sidebar></app-admin-sidebar>

    <main class="admin-main">
      <div class="page-content">
        <h1>C·∫•u h√¨nh H·ªá th·ªëng</h1>
        <p class="page-description">
          Qu·∫£n l√Ω c√°c thi·∫øt l·∫≠p h·ªá th·ªëng. B·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t c·∫•u h√¨nh c∆° b·∫£n ho·∫∑c qu·∫£n l√Ω t·∫•t c·∫£ c√°c c·∫•u h√¨nh.
        </p>

        <!-- Tabs -->
        <div class="tabs">
          <button
            class="tab-btn"
            [class.active]="activeTab === 'basic'"
            (click)="switchTab('basic')"
          >
            ‚öôÔ∏è C·∫•u h√¨nh C∆° b·∫£n
          </button>
          <button
            class="tab-btn"
            [class.active]="activeTab === 'all'"
            (click)="switchTab('all')"
          >
            üìã Qu·∫£n l√Ω T·∫•t c·∫£ Configs
          </button>
        </div>

        @if (errorMessage) {
          <div class="alert alert-error">{{ errorMessage }}</div>
        }

        @if (successMessage) {
          <div class="alert alert-success">{{ successMessage }}</div>
        }

        <!-- Basic Config Tab -->
        @if (activeTab === 'basic') {
          @if (loadingData) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>ƒêang t·∫£i c·∫•u h√¨nh...</p>
            </div>
          } @else {
            <div class="config-container">
              <div class="config-card">
                <div class="card-header">
                  <h2>‚öôÔ∏è C√†i ƒë·∫∑t H·ªá th·ªëng</h2>
                  <p class="card-description">
                    C√°c thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c cho c√°c giao d·ªãch m·ªõi.
                  </p>
                </div>

                <form [formGroup]="form" (ngSubmit)="onSubmit()">
                  <div class="form-section">
                    <h3>üìÖ Th·ªùi gian m∆∞·ª£n s√°ch</h3>
                    <div class="form-group">
                      <label for="loanPeriodDays">
                        S·ªë ng√†y m∆∞·ª£n s√°ch (ng√†y) *
                        <span class="help-text">Th·ªùi gian t·ªëi ƒëa m√† th√†nh vi√™n c√≥ th·ªÉ m∆∞·ª£n m·ªôt cu·ªën s√°ch</span>
                      </label>
                      <input
                        id="loanPeriodDays"
                        type="number"
                        formControlName="loanPeriodDays"
                        min="1"
                        placeholder="V√≠ d·ª•: 7"
                      />
                      @if (form.get('loanPeriodDays')?.invalid && form.get('loanPeriodDays')?.touched) {
                        <span class="error-text">
                          @if (form.get('loanPeriodDays')?.errors?.['required']) {
                            S·ªë ng√†y m∆∞·ª£n s√°ch l√† b·∫Øt bu·ªôc
                          } @else if (form.get('loanPeriodDays')?.errors?.['min']) {
                            S·ªë ng√†y m∆∞·ª£n s√°ch ph·∫£i l·ªõn h∆°n 0
                          }
                        </span>
                      }
                      @if (config) {
                        <div class="info-text">
                          Hi·ªán t·∫°i: <strong>{{ config.loanPeriodDays }} ng√†y</strong>
                        </div>
                      }
                    </div>
                  </div>

                  <div class="form-section">
                    <h3>üí∞ Ti·ªÅn ph·∫°t</h3>
                    <div class="form-group">
                      <label for="finePerDay">
                        Ti·ªÅn ph·∫°t m·ªói ng√†y qu√° h·∫°n (VND) *
                        <span class="help-text">S·ªë ti·ªÅn ph·∫°t t√≠nh cho m·ªói ng√†y tr·∫£ s√°ch qu√° h·∫°n</span>
                      </label>
                      <input
                        id="finePerDay"
                        type="number"
                        formControlName="finePerDay"
                        min="0"
                        step="1000"
                        placeholder="V√≠ d·ª•: 10000"
                      />
                      @if (form.get('finePerDay')?.invalid && form.get('finePerDay')?.touched) {
                        <span class="error-text">
                          @if (form.get('finePerDay')?.errors?.['required']) {
                            Ti·ªÅn ph·∫°t m·ªói ng√†y l√† b·∫Øt bu·ªôc
                          } @else if (form.get('finePerDay')?.errors?.['min']) {
                            Ti·ªÅn ph·∫°t m·ªói ng√†y ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng 0
                          }
                        </span>
                      }
                      @if (config) {
                        <div class="info-text">
                          Hi·ªán t·∫°i: <strong>{{ formatCurrency(config.finePerDay) }}</strong>
                        </div>
                      }
                    </div>
                  </div>

                  <div class="form-section">
                    <h3>üìö Gi·ªõi h·∫°n m∆∞·ª£n s√°ch</h3>
                    <div class="form-group">
                      <label for="maxBooksPerMember">
                        S·ªë s√°ch t·ªëi ƒëa m·ªói th√†nh vi√™n *
                        <span class="help-text">S·ªë l∆∞·ª£ng s√°ch t·ªëi ƒëa m√† m·ªôt th√†nh vi√™n c√≥ th·ªÉ m∆∞·ª£n c√πng l√∫c</span>
                      </label>
                      <input
                        id="maxBooksPerMember"
                        type="number"
                        formControlName="maxBooksPerMember"
                        min="1"
                        placeholder="V√≠ d·ª•: 5"
                      />
                      @if (form.get('maxBooksPerMember')?.invalid && form.get('maxBooksPerMember')?.touched) {
                        <span class="error-text">
                          @if (form.get('maxBooksPerMember')?.errors?.['required']) {
                            S·ªë s√°ch t·ªëi ƒëa l√† b·∫Øt bu·ªôc
                          } @else if (form.get('maxBooksPerMember')?.errors?.['min']) {
                            S·ªë s√°ch t·ªëi ƒëa ph·∫£i l·ªõn h∆°n 0
                          }
                        </span>
                      }
                      @if (config) {
                        <div class="info-text">
                          Hi·ªán t·∫°i: <strong>{{ config.maxBooksPerMember }} cu·ªën</strong>
                        </div>
                      }
                    </div>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="submit-btn" [disabled]="loading || form.invalid">
                      @if (loading) {
                        <span class="btn-spinner"></span>
                        ƒêang c·∫≠p nh·∫≠t...
                      } @else {
                        üíæ L∆∞u c·∫•u h√¨nh
                      }
                    </button>
                    <button type="button" class="cancel-btn" (click)="loadConfig()" [disabled]="loading">
                      üîÑ L√†m m·ªõi
                    </button>
                  </div>
                </form>
              </div>

              @if (config) {
                <div class="info-card">
                  <h3>‚ÑπÔ∏è Th√¥ng tin</h3>
                  <div class="info-list">
                    <div class="info-item">
                      <span class="info-label">Th·ªùi gian m∆∞·ª£n:</span>
                      <span class="info-value">{{ config.loanPeriodDays }} ng√†y</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Ti·ªÅn ph·∫°t/ng√†y:</span>
                      <span class="info-value">{{ formatCurrency(config.finePerDay) }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Gi·ªõi h·∫°n m∆∞·ª£n:</span>
                      <span class="info-value">{{ config.maxBooksPerMember }} cu·ªën</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        }

        <!-- All Configs Tab -->
        @if (activeTab === 'all') {
          <div class="all-configs-container">
            <div class="configs-header">
              <h2>üìã Danh s√°ch C·∫•u h√¨nh</h2>
              <button class="add-btn" (click)="showAddConfigForm()" [disabled]="loading">
                ‚ûï Th√™m Config M·ªõi
              </button>
            </div>

            @if (loadingAllConfigs) {
              <div class="loading-state">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i danh s√°ch c·∫•u h√¨nh...</p>
              </div>
            } @else {
              <!-- Add Config Form -->
              @if (showAddForm) {
                <div class="config-form-card">
                  <h3>‚ûï Th√™m Config M·ªõi</h3>
                  <form [formGroup]="addConfigForm" (ngSubmit)="onSubmitAddConfig()">
                    <div class="form-group">
                      <label for="configKey">Config Key *</label>
                      <input
                        id="configKey"
                        type="text"
                        formControlName="configKey"
                        placeholder="V√≠ d·ª•: loan.max.days"
                      />
                      <span class="help-text">Ch·ªâ d√πng ch·ªØ th∆∞·ªùng, s·ªë v√† d·∫•u ch·∫•m (v√≠ d·ª•: loan.period.days)</span>
                      @if (addConfigForm.get('configKey')?.invalid && addConfigForm.get('configKey')?.touched) {
                        <span class="error-text">Config key kh√¥ng h·ª£p l·ªá</span>
                      }
                    </div>

                    <div class="form-group">
                      <label for="configValue">Gi√° tr·ªã *</label>
                      <input
                        id="configValue"
                        type="text"
                        formControlName="configValue"
                        placeholder="Nh·∫≠p gi√° tr·ªã"
                      />
                      @if (addConfigForm.get('configValue')?.invalid && addConfigForm.get('configValue')?.touched) {
                        <span class="error-text">Gi√° tr·ªã l√† b·∫Øt bu·ªôc</span>
                      }
                    </div>

                    <div class="form-group">
                      <label for="dataType">Ki·ªÉu d·ªØ li·ªáu *</label>
                      <select id="dataType" formControlName="dataType">
                        @for (type of dataTypes; track type) {
                          <option [value]="type">{{ type }}</option>
                        }
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="configGroup">Nh√≥m</label>
                      <input
                        id="configGroup"
                        type="text"
                        formControlName="configGroup"
                        placeholder="V√≠ d·ª•: loan, fine, member"
                      />
                    </div>

                    <div class="form-group">
                      <label for="description">M√¥ t·∫£</label>
                      <textarea
                        id="description"
                        formControlName="description"
                        rows="3"
                        placeholder="M√¥ t·∫£ v·ªÅ config n√†y..."
                      ></textarea>
                    </div>

                    <div class="form-actions">
                      <button type="submit" class="submit-btn" [disabled]="loading || addConfigForm.invalid">
                        @if (loading) {
                          <span class="btn-spinner"></span>
                          ƒêang t·∫°o...
                        } @else {
                          üíæ T·∫°o Config
                        }
                      </button>
                      <button type="button" class="cancel-btn" (click)="cancelAddForm()" [disabled]="loading">
                        H·ªßy
                      </button>
                    </div>
                  </form>
                </div>
              }

              <!-- Configs List -->
              @if (allConfigs.length === 0) {
                <div class="empty-state">Ch∆∞a c√≥ c·∫•u h√¨nh n√†o.</div>
              } @else {
                @for (group of getConfigsByGroup() | keyvalue; track group.key) {
                  <div class="config-group">
                    <h3 class="group-title">{{ group.key || 'Kh√°c' }}</h3>
                    <div class="configs-table">
                      <table class="simple-table">
                        <thead>
                          <tr>
                            <th>Key</th>
                            <th>Gi√° tr·ªã</th>
                            <th>Ki·ªÉu</th>
                            <th>M√¥ t·∫£</th>
                            <th>Thao t√°c</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (config of group.value; track config.id) {
                            <tr>
                              @if (editingConfig?.id === config.id) {
                                <td colspan="5">
                                  <form [formGroup]="editConfigForm" (ngSubmit)="onSubmitEditConfig()" class="inline-edit-form">
                                    <div class="inline-edit-controls">
                                      <input
                                        type="text"
                                        formControlName="configValue"
                                        placeholder="Nh·∫≠p gi√° tr·ªã m·ªõi"
                                      />
                                      <button type="submit" class="btn-small btn-primary" [disabled]="loading || editConfigForm.invalid">
                                        üíæ
                                      </button>
                                      <button type="button" class="btn-small btn-secondary" (click)="cancelEdit()" [disabled]="loading">
                                        ‚ùå
                                      </button>
                                    </div>
                                  </form>
                                </td>
                              } @else {
                                <td><code>{{ config.configKey }}</code></td>
                                <td><strong>{{ formatConfigValue(config) }}</strong></td>
                                <td><span class="badge badge-type">{{ config.dataType }}</span></td>
                                <td>{{ config.description || '-' }}</td>
                                <td>
                                  <div class="action-buttons">
                                    <button class="btn-small btn-primary" (click)="editConfig(config)" [disabled]="loading">
                                      ‚úèÔ∏è
                                    </button>
                                    <button class="btn-small btn-danger" (click)="deleteConfig(config)" [disabled]="loading">
                                      üóëÔ∏è
                                    </button>
                                  </div>
                                </td>
                              }
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                }
              }
            }
          </div>
        }
      </div>
    </main>
  </div>
</div>
