<div class="search-books-wrapper">
  <header class="search-header">
    <div class="logo">üìö Library Management</div>
    <div class="header-right">
      <a routerLink="/home" class="nav-link">Trang ch·ªß</a>
      <button class="logout-btn" (click)="onLogout()">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <main class="search-main">
    <div class="container">
      <h1 class="page-title">T√¨m ki·∫øm s√°ch</h1>

      <!-- Search Form -->
      <div class="search-card">
        <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
          <div class="form-grid">
            <div class="form-group">
              <label for="title">Ti√™u ƒë·ªÅ s√°ch</label>
              <input
                id="title"
                type="text"
                formControlName="title"
                placeholder="Nh·∫≠p ti√™u ƒë·ªÅ s√°ch..."
              />
            </div>

            <div class="form-group">
              <label for="authorName">T√°c gi·∫£</label>
              <input
                id="authorName"
                type="text"
                formControlName="authorName"
                placeholder="Nh·∫≠p t√™n t√°c gi·∫£..."
              />
            </div>

            <div class="form-group">
              <label for="categoryId">Th·ªÉ lo·∫°i</label>
              <select
                id="categoryId"
                formControlName="categoryId"
                (change)="onSearch()"
              >
                <option [value]="null">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
                @for (category of categories; track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="publicationYear">NƒÉm xu·∫•t b·∫£n</label>
              <input
                id="publicationYear"
                type="number"
                formControlName="publicationYear"
                placeholder="VD: 2020"
                min="1900"
                max="2100"
              />
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              üîç T√¨m ki·∫øm
            </button>
            <button type="button" class="btn btn-secondary" (click)="onReset()" [disabled]="loading">
              üîÑ L√†m m·ªõi
            </button>
          </div>
        </form>
      </div>

      <!-- Messages -->
      @if (errorMessage) {
        <div class="alert alert-error">{{ errorMessage }}</div>
      }
      @if (successMessage) {
        <div class="alert alert-success">{{ successMessage }}</div>
      }

      <!-- Results -->
      @if (loading) {
        <div class="loading-container">
          <div class="loading">ƒêang t·∫£i...</div>
        </div>
      } @else if (books.length === 0) {
        <div class="empty-state">
          <p>Kh√¥ng t√¨m th·∫•y s√°ch n√†o.</p>
          <p class="empty-hint">Th·ª≠ thay ƒë·ªïi ti√™u ch√≠ t√¨m ki·∫øm c·ªßa b·∫°n.</p>
        </div>
      } @else {
        <div class="results-header">
          <h2>T√¨m th·∫•y {{ books.length }} cu·ªën s√°ch</h2>
        </div>

        <div class="books-grid">
          @for (book of books; track book.id) {
            <div class="book-card">
              <div class="book-image">
                @if (book.image) {
                  <img [src]="book.image" [alt]="book.title" />
                } @else {
                  <div class="book-placeholder">üìñ</div>
                }
              </div>
              <div class="book-info">
                <h3 class="book-title">{{ book.title }}</h3>
                <div class="book-meta">
                  <p class="book-isbn">ISBN: {{ book.isbn }}</p>
                  <p class="book-year">NƒÉm: {{ book.publicationYear }}</p>
                  @if (book.category) {
                    <p class="book-category">Th·ªÉ lo·∫°i: {{ book.category.name }}</p>
                  }
                  @if (book.authors && book.authors.length > 0) {
                    <p class="book-authors">T√°c gi·∫£: {{ formatAuthors(book) }}</p>
                  }
                </div>
                <div class="book-availability">
                  <span class="availability-label">S·∫µn c√≥:</span>
                  <span class="availability-value" [class.available]="book.availableCopies > 0" [class.unavailable]="book.availableCopies === 0">
                    {{ book.availableCopies }}/{{ book.totalCopies }}
                  </span>
                </div>
                <div class="book-actions">
                  <button class="btn btn-sm btn-info" (click)="viewBookDetail(book)">
                    üëÅÔ∏è Chi ti·∫øt
                  </button>
                  @if (canBorrow(book)) {
                    <button class="btn btn-sm btn-success" (click)="borrowBook(book)" [disabled]="loading">
                      üìñ M∆∞·ª£n s√°ch
                    </button>
                  }
                  @if (canReserve(book)) {
                    <button class="btn btn-sm btn-warning" (click)="reserveBook(book)" [disabled]="loading">
                      üìå ƒê·∫∑t ch·ªó
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </main>

  <!-- Book Detail Modal -->
  @if (showBookDetail && selectedBook) {
    <div class="modal-overlay" (click)="closeBookDetail()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ selectedBook.title }}</h2>
          <button class="modal-close" (click)="closeBookDetail()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="book-detail-image">
            @if (selectedBook.image) {
              <img [src]="selectedBook.image" [alt]="selectedBook.title" />
            } @else {
              <div class="book-placeholder-large">üìñ</div>
            }
          </div>
          <div class="book-detail-info">
            <div class="detail-row">
              <span class="detail-label">ISBN:</span>
              <span class="detail-value">{{ selectedBook.isbn }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">NƒÉm xu·∫•t b·∫£n:</span>
              <span class="detail-value">{{ selectedBook.publicationYear }}</span>
            </div>
            @if (selectedBook.category) {
              <div class="detail-row">
                <span class="detail-label">Th·ªÉ lo·∫°i:</span>
                <span class="detail-value">{{ selectedBook.category.name }}</span>
              </div>
            }
            @if (selectedBook.authors && selectedBook.authors.length > 0) {
              <div class="detail-row">
                <span class="detail-label">T√°c gi·∫£:</span>
                <span class="detail-value">{{ formatAuthors(selectedBook) }}</span>
              </div>
            }
            <div class="detail-row">
              <span class="detail-label">T·ªïng s·ªë b·∫£n:</span>
              <span class="detail-value">{{ selectedBook.totalCopies }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">S·∫µn c√≥:</span>
              <span class="detail-value" [class.available]="selectedBook.availableCopies > 0" [class.unavailable]="selectedBook.availableCopies === 0">
                {{ selectedBook.availableCopies }}
              </span>
            </div>
            @if (selectedBook.description) {
              <div class="detail-row description-row">
                <span class="detail-label">M√¥ t·∫£:</span>
                <div class="detail-value description-text">{{ selectedBook.description }}</div>
              </div>
            }
          </div>
        </div>
        <div class="modal-footer">
          @if (canBorrow(selectedBook)) {
            <button class="btn btn-success" (click)="borrowBook(selectedBook)" [disabled]="loading">
              üìñ M∆∞·ª£n s√°ch
            </button>
          }
          @if (canReserve(selectedBook)) {
            <button class="btn btn-warning" (click)="reserveBook(selectedBook)" [disabled]="loading">
              üìå ƒê·∫∑t ch·ªó
            </button>
          }
          <button class="btn btn-secondary" (click)="closeBookDetail()">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  }
</div>

